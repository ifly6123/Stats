<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide: The F-Test & ANOVA</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
</head>
<body>
    <nav class="breadcrumb">
        <a href="../index.html">Home</a> &gt;
        <a href="../study-guides.html">Study Guides</a> &gt;
        <span>The F-Test & ANOVA</span>
    </nav>
    <header class="module-header">
        <h1 class="gradient-text-grey">The F-Test & ANOVA ðŸ“Š</h1>
        <p>Comparing the averages of <em>three or more</em> groups.</p>
    </header>

    <main class="guide-content">
        <h2>Why Do We Need a New Test?</h2>
        <p>In the last guide, we used a <strong>t-test</strong> to compare two groups (like "Group A" vs. "Group B").</p>
        <p>But what if we have three groups? Or four? Or five? For example, what if we want to compare the plant growth from <strong>Fertilizer A, Fertilizer B, and Fertilizer C</strong> all at once?</p>
        <p>You might think, "I'll just do a bunch of t-tests!" (A vs. B, A vs. C, B vs. C). <strong>This is a bad idea!</strong> The more tests you run, the higher your chance of getting a "false positive" (a fluke) just by random luck. </p>

        <h2>ANOVA: The One Test to Rule Them All</h2>
        <p>Instead, we use a test called <strong>ANOVA</strong>, which stands for <strong>AN</strong>alysis <strong>O</strong>f <strong>VA</strong>riance. ANOVA lets you compare all the group means at once with a single test.</p>
        <p>The "verdict" from this test is a single number called the <strong>F-statistic</strong> (or F-value), which gives you a single <strong>p-value</strong>.</p>

        <h3>The Hypotheses for ANOVA</h3>
        <ul>
            <li><strong>Null Hypothesis ($H_0$):</strong> All the group means are the same. (e.g., "All three fertilizers work equally well." $\mu_A = \mu_B = \mu_C$)</li>
            <li><strong>Alternative Hypothesis ($H_a$):</strong> At least <em>one</em> of the group means is different from the others. (e.g., "At least one fertilizer is different." $\mu_A \neq \mu_B$ or $\mu_A \neq \mu_C$ or $\mu_B \neq \mu_C$)</li>
        </ul>

        <h2>Signal vs. Noise (Again!)</h2>
        <p>Just like the t-test, the F-test is a simple <strong>"Signal-to-Noise Ratio"</strong>. It asks: "Is the difference <em>between</em> the group means (Signal) much bigger than the random spread <em>within</em> the groups (Noise)?"</p>
        <p style="text-align: center; font-size: 1.5rem; font-weight: 600;">$F = \frac{\text{Variance BETWEEN Groups (Signal)}}{\text{Variance WITHIN Groups (Noise)}}$</p>
        <ul>
            <li>A <strong>High $F$-value</strong> (like 5 or 10) means the Signal is much stronger than the Noise. The groups are <em>really</em> different. This gives a <strong>low p-value</strong>.</li>
            <li>A <strong>Low $F$-value</strong> (like 1 or less) means the Noise is as big as the Signal. The differences are probably just a random fluke. This gives a <strong>high p-value</strong>.</li>
        </ul>

        <hr style="margin: 30px 0;">

        <h2>Interactive: ANOVA Visualizer (Signal vs. Noise)</h2>
        <p>Here are three groups (A, B, C), each with 20 data points. Use the sliders to see how Signal and Noise affect the F-value and p-value.</p>

        <div class="interactive-calc dark-bg">
            <div id="anova-plot-container">
                <div id="anova-plot"></div>
            </div>

            <div class="ttest-controls">
                <div class="control-group">
                    <label for="anova-mean-slider">Difference Between Group Means (The "Signal")</label>
                    <input type="range" class="slider" id="anova-mean-slider" min="0" max="15" step="0.5" value="3">
                </div>
                <div class="control-group">
                    <label for="anova-sd-slider">Spread Within Groups (The "Noise")</label>
                    <input type="range" class="slider" id="anova-sd-slider" min="1" max="10" step="0.5" value="5">
                </div>
            </div>

            <div class="calc-results-grid">
                <div class="calc-stat-box compact" id="mean-box-disp">
                    <strong>F-value (Signal/Noise)</strong>
                    <span id="stat-f-value">0.00</span>
                </div>
                <div class="calc-stat-box compact" id="sd-box-disp">
                    <strong>p-value ("Fluke Meter")</strong>
                    <span id="stat-p-value">0.000</span>
                </div>
            </div>
            <div id="anova-conclusion" class="stat-result not-significant">
                <span>Move the sliders to see the result.</span>
            </div>
        </div>
        <hr style="margin: 30px 0;">

        <h2>What Did You See?</h2>
        <p>You should have noticed two things in the simulator:</p>
        <ol>
            <li><strong>Increasing the "Signal" (Difference):</strong> As you spread the three group means apart, the $F$-value gets <strong>bigger</strong> and the $p$-value gets <strong>smaller</strong>. The difference is clear.</li>
            <li><strong>Increasing the "Noise" (Spread):</strong> As you make the dot clusters for each group wider and more spread out, they overlap more. This makes the $F$-value <strong>smaller</strong> and the $p$-value <strong>bigger</strong>.</li>
        </ol>
        <p>This is the core concept of ANOVA! If the $p$-value is significant (e.g., $p < 0.05$), it tells you, "Yes, there is a difference to be found here!" It <em>doesn't</em> tell you which specific group is different (e.g., A > C), just that <em>at least one</em> is different. (To find out which one, you use a "post-hoc test," which is a later topic).</p>
        <p>You can see full ANOVA tables in action in our <a href="../module4.html">Module 4: Virtual Field</a>!</p>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <script>document.addEventListener("DOMContentLoaded", function () { renderMathInElement(document.body, { delimiters: [{ left: "$", right: "$", display: false }] }); });</script>

    <script>
        (function setupAnovaViz() {
            // Check for D3 and jStat
            if (typeof d3 === 'undefined' || typeof jStat === 'undefined') {
                console.error("D3.js or jStat.js is not loaded! Cannot start simulator.");
                document.querySelector("#anova-plot-container").innerHTML = "<p style='color: red; padding: 10px;'>Error: Simulator could not be loaded.</p>";
                return;
            }

            // --- 1. Setup ---
            const margin = { top: 20, right: 20, bottom: 40, left: 40 };
            const width = 500 - margin.left - margin.right;
            const height = 250 - margin.top - margin.bottom;

            let groupA, groupB, groupC; // To hold data
            const nPerGroup = 20;

            const svg = d3.select("#anova-plot").append("svg")
                .attr("width", "100%").attr("height", height + margin.top + margin.bottom)
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);

            // Sliders and value displays
            const meanSlider = d3.select("#anova-mean-slider");
            const sdSlider = d3.select("#anova-sd-slider");

            // Stats displays
            const fValueDisplay = d3.select("#stat-f-value");
            const pValueDisplay = d3.select("#stat-p-value");
            const conclusionEl = d3.select("#anova-conclusion");

            // --- 2. Scales ---
            const xScale = d3.scaleLinear().domain([-30, 30]).range([0, width]);
            const xAxis = svg.append("g").attr("class", "axis").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(xScale).ticks(7));

            // Y-Scale (for dot plot jitter)
            const yScale = d3.scaleLinear().domain([0, 1]).range([height - 20, 20]); // 20px padding

            const colorScale = d3.scaleOrdinal()
                .domain(['A', 'B', 'C'])
                .range(['#007bff', '#28a745', '#fd7e14']); // Blue, Green, Orange

            const dotGroup = svg.append("g").attr("class", "dots");
            const annoGroup = svg.append("g").attr("class", "annotations");

            // --- 3. Helper Functions ---
            function generateData(meanDiff, sd) {
                const meanA = -meanDiff;
                const meanB = 0;
                const meanC = meanDiff;

                // Generate new data
                groupA = d3.range(nPerGroup).map(() => ({ group: 'A', value: d3.randomNormal(meanA, sd)() }));
                groupB = d3.range(nPerGroup).map(() => ({ group: 'B', value: d3.randomNormal(meanB, sd)() }));
                groupC = d3.range(nPerGroup).map(() => ({ group: 'C', value: d3.randomNormal(meanC, sd)() }));

                return [groupA, groupB, groupC];
            }

            function calculateAnova(groups) {
                const [groupA_vals, groupB_vals, groupC_vals] = groups.map(g => g.map(d => d.value));

                try {
                    const f_stat = jStat.anova.oneway([groupA_vals, groupB_vals, groupC_vals]);
                    const df_between = 2; // k - 1 (3 groups - 1)
                    const df_within = (nPerGroup - 1) * 3; // (n-1) * k

                    // Get p-value from F-statistic
                    const p_value = 1 - jStat.centralF.cdf(f_stat, df_between, df_within);

                    return { f: f_stat, p: p_value };
                } catch (e) {
                    console.error("jStat error:", e);
                    return { f: 0, p: 1 };
                }
            }

            // --- 4. Update Function ---
            function update() {
                const meanDiff = +meanSlider.property("value");
                const stdDev = +sdSlider.property("value");

                const groups = generateData(meanDiff, stdDev);
                const allData = [].concat(...groups);

                // Update dots
                dotGroup.selectAll("circle")
                    .data(allData)
                    .join("circle")
                    .attr("class", "data-dot-interactive")
                    .attr("r", 4)
                    .style("fill", d => colorScale(d.group))
                    .style("opacity", 0.6)
                    .transition().duration(100)
                    .attr("cx", d => xScale(d.value))
                    .attr("cy", d => yScale(Math.random())); // Jitter

                // Update mean lines
                const meanData = [
                    { group: 'A', mean: d3.mean(groupA, d => d.value) },
                    { group: 'B', mean: d3.mean(groupB, d => d.value) },
                    { group: 'C', mean: d3.mean(groupC, d => d.value) }
                ];

                annoGroup.selectAll("line")
                    .data(meanData)
                    .join("line")
                    .attr("class", "mean-line")
                    .transition().duration(100)
                    .attr("x1", d => xScale(d.mean))
                    .attr("x2", d => xScale(d.mean))
                    .attr("y1", 0)
                    .attr("y2", height)
                    .style("stroke", d => colorScale(d.group))
                    .style("stroke-width", 3)
                    .style("stroke-dasharray", "4 4");

                // Calculate and display stats
                const { f, p } = calculateAnova(groups);

                fValueDisplay.text(f.toFixed(2));
                pValueDisplay.text(p.toFixed(3));

                // Update conclusion
                if (p < 0.05) {
                    conclusionEl.text("Statistically Significant! (p < 0.05)");
                    conclusionEl.classed("significant", true).classed("not-significant", false);
                    pValueDisplay.style("color", "#dc3545"); // Red
                } else {
                    conclusionEl.text("Not Significant (p â‰¥ 0.05)");
                    conclusionEl.classed("significant", false).classed("not-significant", true);
                    pValueDisplay.style("color", "#28a745"); // Green
                }
            }

            // --- 5. Event Listeners ---
            meanSlider.on("input", update);
            sdSlider.on("input", update);

            // Initial call
            update();

        })();
    </script>

</body>
</html>